<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Cart</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar placeholder -->
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h3>Cart Items</h3>
    <div id="cart-items" class="row"></div>
  </div>

  <script>
    const userId = sessionStorage.getItem("userId");
    const userRole = sessionStorage.getItem("userRole");

    if (!userId) {
      window.location.href = "login.html";
    }

    // Load navbar and apply role-based logic
    fetch("navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar-placeholder").innerHTML = html;

        if (userRole !== "ADMIN") {
          document.querySelector("a[href='admin.html']")?.parentElement?.remove();
        }

        if (userRole !== "ADMIN" && window.location.pathname.includes("admin.html")) {
          window.location.href = "index.html";
        }

        document.getElementById("loginLink")?.remove();
        document.getElementById("signupLink")?.remove();

        const logoutItem = document.createElement("li");
        logoutItem.className = "nav-item";
        logoutItem.innerHTML = `<a class="nav-link" href="#" onclick="logout()">Logout</a>`;
        document.getElementById("navMenu")?.appendChild(logoutItem);
      });

    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }

    // Fetch and display cart items
    fetch(`http://localhost:8081/user/cart/item/${userId}`)
      .then(res => res.json())
      .then(items => {
        const container = document.getElementById("cart-items");

        if (items.length === 0) {
          container.innerHTML = `<p>Your cart is empty. Start browsing books!</p>`;
          return;
        }

        items.forEach(item => {
          container.innerHTML += `
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body">
                  <h5>${item.book.bookName}</h5>
                  <p>Author: ${item.book.author}</p>
                  <p>â‚¹${item.book.price}</p>
                  <p>Quantity: ${item.quantity}</p>
                  <button class="btn btn-danger me-2" onclick="removeItem(${item.cartId})">Remove</button>
                  <button class="btn btn-success" onclick="placeOrder(${item.book.bookId}, ${item.quantity})">Order</button>
                </div>
              </div>
            </div>`;
        });
      })
      .catch(() => {
        document.getElementById("cart-items").innerHTML = `<p>Unable to load cart. Please try again later.</p>`;
      });

    function removeItem(cartId) {
      fetch(`http://localhost:8081/user/cart/${cartId}`, {
        method: "DELETE"
      })
      .then(() => location.reload())
      .catch(() => alert("Failed to remove item"));
    }

    function placeOrder(bookId, quantity) {
      fetch(`http://localhost:8081/user/orders/place?userId=${userId}&bookId=${bookId}&quantity=${quantity}`, {
        method: "POST"
      })
      .then(() => alert("Order placed!"))
      .catch(() => alert("Failed to place order"));
    }
  </script>
</body>
</html>
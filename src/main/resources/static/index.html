<!DOCTYPE html>
<html lang="en">
<head>
  <title>BookShop Home</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h2>Available Books</h2>
    <div id="book-list" class="row"></div>
  </div>

  <script>
    const userId = sessionStorage.getItem("userId");
    const userRole = sessionStorage.getItem("userRole");

    if (!userId) window.location.href = "login.html";

    // 🌐 Inject navbar then apply role-based logic
    fetch("navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar-placeholder").innerHTML = html;

        // Remove Login/Signup for logged-in users
        document.getElementById("loginLink")?.remove();
        document.getElementById("signupLink")?.remove();

        // Add Logout link
        const logoutItem = document.createElement("li");
        logoutItem.className = "nav-item";
        logoutItem.innerHTML = `<a class="nav-link" href="#" onclick="logout()">Logout</a>`;
        document.getElementById("navMenu")?.appendChild(logoutItem);

        // Role-based link hiding
        if (userRole === "ADMIN") {
          document.getElementById("cartLink")?.remove();
          document.getElementById("ordersLink")?.remove();
        } else {
          document.getElementById("adminLink")?.remove();
          if (window.location.pathname.endsWith("admin.html")) {
            window.location.href = "index.html";
          }
        }
      });

    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }

    // 📚 Fetch books and display
    fetch("http://localhost:8081/books")
      .then(res => res.json())
      .then(books => {
        const bookList = document.getElementById("book-list");

        if (!books.length) {
          bookList.innerHTML = "<p>No books available. Please check back soon!</p>";
          return;
        }

        books.forEach(book => {
          bookList.innerHTML += `
            <div class="col-md-4">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="card-title">${book.bookName}</h5>
                  <p class="card-text">Author: ${book.author}</p>
                  <p class="card-text">₹${book.price}</p>

                  ${
                    userRole !== "ADMIN"
                      ? `<button class="btn btn-primary" onclick="toggleQuantity(${book.bookId})">Add to Cart</button>
                         <div id="quantity-box-${book.bookId}" class="mt-2 d-none">
                           <div class="input-group">
                             <button class="btn btn-outline-secondary" onclick="decreaseQuantity(${book.bookId})">−</button>
                             <input type="number" id="quantity-${book.bookId}" value="1" min="1" class="form-control text-center" />
                             <button class="btn btn-outline-secondary" onclick="increaseQuantity(${book.bookId})">+</button>
                           </div>
                           <button class="btn btn-success mt-2" onclick="confirmAddToCart(${book.bookId})">Confirm Add</button>
                         </div>`
                      : ""
                  }
                </div>
              </div>
            </div>`;
        });
      })
      .catch(() => {
        document.getElementById("book-list").innerHTML = "<p>Failed to load books. Please try again later.</p>";
      });

    function toggleQuantity(bookId) {
      document.getElementById(`quantity-box-${bookId}`).classList.toggle("d-none");
    }

    function increaseQuantity(bookId) {
      const input = document.getElementById(`quantity-${bookId}`);
      input.value = parseInt(input.value) + 1;
    }

    function decreaseQuantity(bookId) {
      const input = document.getElementById(`quantity-${bookId}`);
      const current = parseInt(input.value);
      if (current > 1) input.value = current - 1;
    }

    function confirmAddToCart(bookId) {
      const quantity = parseInt(document.getElementById(`quantity-${bookId}`).value);

      const cartItem = {
        userId: parseInt(userId),
        book: { bookId },
        quantity
      };

      fetch("http://localhost:8081/user/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cartItem)
      })
      .then(() => alert(`Added ${quantity} item(s) to cart`))
      .catch(() => alert("Failed to add item"));
    }
  </script>
</body>
</html>
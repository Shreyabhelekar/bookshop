<!DOCTYPE html>
<html lang="en">
<head>
  <title>Order History</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar placeholder -->
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h3 class="mb-3">Order History</h3>
    <div id="order-list" class="row"></div>
  </div>

  <script>
    const userId = sessionStorage.getItem("userId");
    const userRole = sessionStorage.getItem("userRole");

    // Redirect if not logged in
    if (!userId) window.location.href = "login.html";

    // Load navbar
    fetch("navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar-placeholder").innerHTML = html;

        // Hide admin link if not ADMIN
        if (userRole !== "ADMIN") {
          const adminLink = document.querySelector("a[href='admin.html']");
          if (adminLink) adminLink.parentElement.remove();
        }

        // Remove login/signup and add logout
        document.getElementById("loginLink")?.remove();
        document.getElementById("signupLink")?.remove();

        const logoutItem = document.createElement("li");
        logoutItem.className = "nav-item";
        logoutItem.innerHTML = `<a class="nav-link" href="#" onclick="logout()">Logout</a>`;
        document.getElementById("navMenu")?.appendChild(logoutItem);
      });

    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }

    // Fetch and display orders
    fetch(`http://localhost:8081/user/orders/${userId}`)
      .then(res => res.json())
      .then(orders => {
        const container = document.getElementById("order-list");

        if (!orders.length) {
          container.innerHTML = `<p>No orders yet. Start shopping now!</p>`;
          return;
        }

        orders.forEach(order => {
          const formattedDate = order.orderDate
            ? new Date(order.orderDate).toLocaleString('en-IN')
            : "Date not available";

          const formattedPrice = typeof order.price === "number"
            ? `â‚¹${order.price.toFixed(2)}`
            : "Price not available";

          container.innerHTML += `
            <div class="col-md-4 mb-3">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title">${order.book.bookName}</h5>
                  <p class="card-text">Quantity: ${order.quantity}</p>
                  <p class="card-text">Price: ${formattedPrice}</p>
                  <p class="card-text">Date: ${formattedDate}</p>
                </div>
              </div>
            </div>
          `;
        });
      })
      .catch(err => {
        console.error("Order fetch error:", err);
        document.getElementById("order-list").innerHTML = `<p>Unable to load orders. Please try again later.</p>`;
      });
  </script>
</body>
</html>